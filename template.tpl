___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "TikTok Pixel by Stape",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlgAAAJYCAYAAAC+ZpjcAAAphElEQVR4Ae3dfazdd33Y8Y+fn0h8AxlPapLrZh0F4viyVWHjYTERUksDStJ/6kInO0JKB9KII7US1SrZaalAmrY4mQRTJWpnWhH/ORGlndYqdkSpRrViA9lG11I7SSsoCpKdNECeyM7nHN/k+vpe3/PwPef39HpJR8dxbgOirfzm+/n+Pr91EfFyADTMy//u5wKgrtYHAABFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSwAgMIEFgBAYQILAKAwgQUAUJjAAgAoTGABABQmsAAAChNYAACFCSygkc4+83wA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\u003d"
  },
  "description": "Tag that integrates TikTok Pixel into the page and allows easy tracking. Note: this tag does not require the Base Code installed as a Custom HTML tag to work.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "baseConfigurationGroup",
    "subParams": [
      {
        "type": "TEXT",
        "name": "pixelIds",
        "displayName": "TikTok Pixel ID(s)",
        "simpleValueType": true,
        "valueHint": "CSQ69...,D69E2...",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Array, single item string or comma separated string of Pixel IDs.",
        "alwaysInSummary": true
      },
      {
        "type": "SELECT",
        "name": "eventNameSetupMethod",
        "displayName": "Event Name Setup Method",
        "selectItems": [
          {
            "value": "inherit",
            "displayValue": "Inherit from DataLayer"
          },
          {
            "value": "override",
            "displayValue": "Override"
          }
        ],
        "simpleValueType": true,
        "subParams": [
          {
            "type": "RADIO",
            "name": "eventName",
            "radioItems": [
              {
                "value": "standard",
                "displayValue": "Standard",
                "subParams": [
                  {
                    "type": "SELECT",
                    "name": "eventNameStandard",
                    "macrosInSelect": false,
                    "selectItems": [
                      {
                        "value": "Pageview",
                        "displayValue": "Pageview"
                      },
                      {
                        "value": "AddPaymentInfo",
                        "displayValue": "AddPaymentInfo"
                      },
                      {
                        "value": "AddToCart",
                        "displayValue": "AddToCart"
                      },
                      {
                        "value": "AddToWishlist",
                        "displayValue": "AddToWishlist"
                      },
                      {
                        "value": "ApplicationApproval",
                        "displayValue": "ApplicationApproval"
                      },
                      {
                        "value": "CompleteRegistration",
                        "displayValue": "CompleteRegistration"
                      },
                      {
                        "value": "Contact",
                        "displayValue": "Contact"
                      },
                      {
                        "value": "CustomizeProduct",
                        "displayValue": "CustomizeProduct"
                      },
                      {
                        "value": "Download",
                        "displayValue": "Download"
                      },
                      {
                        "value": "FindLocation",
                        "displayValue": "FindLocation"
                      },
                      {
                        "value": "InitiateCheckout",
                        "displayValue": "InitiateCheckout"
                      },
                      {
                        "value": "Lead",
                        "displayValue": "Lead"
                      },
                      {
                        "value": "Purchase",
                        "displayValue": "Purchase"
                      },
                      {
                        "value": "Schedule",
                        "displayValue": "Schedule"
                      },
                      {
                        "value": "Search",
                        "displayValue": "Search"
                      },
                      {
                        "value": "StartTrial",
                        "displayValue": "StartTrial"
                      },
                      {
                        "value": "SubmitApplication",
                        "displayValue": "SubmitApplication"
                      },
                      {
                        "value": "Subscribe",
                        "displayValue": "Subscribe"
                      },
                      {
                        "value": "ViewContent",
                        "displayValue": "ViewContent"
                      }
                    ],
                    "simpleValueType": true,
                    "displayName": "Event Name",
                    "defaultValue": "Pageview"
                  }
                ]
              },
              {
                "value": "custom",
                "displayValue": "Custom",
                "subParams": [
                  {
                    "type": "TEXT",
                    "name": "eventNameCustom",
                    "simpleValueType": true,
                    "displayName": "Event Name",
                    "valueValidators": [
                      {
                        "type": "NON_EMPTY"
                      }
                    ]
                  }
                ]
              }
            ],
            "simpleValueType": true,
            "enablingConditions": [
              {
                "paramName": "eventNameSetupMethod",
                "paramValue": "override",
                "type": "EQUALS"
              }
            ],
            "displayName": "Event Type"
          }
        ],
        "defaultValue": "override",
        "alwaysInSummary": true
      },
      {
        "type": "CHECKBOX",
        "name": "enableDataLayerMapping",
        "checkboxText": "Enable automatic User Data and Event Parameters mapping from the Data Layer",
        "simpleValueType": true,
        "help": "If enabled, the TikTok tag will map standard User Data and Event Parameters automatically from the Data Layer.\n\u003cbr/\u003e\u003cbr/\u003e\nThe tag parses the Universal Analytics,  \u003ca href\u003d\"https://developers.google.com/analytics/devguides/collection/ga4/ecommerce\"\u003eGA4\u003c/a\u003e and \u003ca href\u003d\"https://developers.google.com/tag-platform/tag-manager/server-side/common-event-data\"\u003eCommon Event Data\u003c/a\u003e formats.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eEvent Parameters\u003c/b\u003e auto-mapped parameters:\n\u003cul\u003e\n\u003cli\u003e\u003cb\u003econtents\u003c/b\u003e: GA4 \u003ci\u003eitem[]\u003c/i\u003e or  UA \u003ci\u003eecommerce[action].products[]\u003c/i\u003e from Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003econtent_ids\u003c/b\u003e: GA4 \u003ci\u003eitem[].item_id\u003c/i\u003e or  UA \u003ci\u003eecommerce[action].products[].id\u003c/i\u003e from Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003econtent_type\u003c/b\u003e: if products are found in Data Layer, it\u0027ll always be mapped \u003ci\u003e\"product\"\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003e\u003cb\u003enum_items\u003c/b\u003e: Sum of GA4 \u003ci\u003eitem[].quantity\u003c/i\u003e or  UA \u003ci\u003eecommerce[action].products[].quantity\u003c/i\u003e from Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003evalue\u003c/b\u003e: GA4 \u003ci\u003evalue\u003c/i\u003e or UA \u003ci\u003eecommerce[action].revenue\u003c/i\u003e from Data Layer, or Sum of GA4 \u003ci\u003eitem[].quantity\u003c/i\u003e * \u003ci\u003eitem[].price\u003c/i\u003e or  UA \u003ci\u003eecommerce[action].products[].quantity\u003c/i\u003e * \u003ci\u003eecommerce[action].products[].price\u003c/i\u003e from Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003ecurrency\u003c/b\u003e: GA4 \u003ci\u003eitem[0].currency\u003c/i\u003e or GA4 \u003ci\u003ecurrency\u003c/i\u003e or  UA \u003ci\u003eecommerce.currencyCode\u003c/i\u003e from Data Layer\u003c/li\u003e\n or  UA \u003ci\u003eecommerce[action].products[].id\u003c/i\u003e from Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003esearch_string\u003c/b\u003e: GA4 \u003ci\u003esearch_term\u003c/i\u003e from Data Layer\u003c/li\u003e\n\u003c/ul\u003e\n\u003cbr/\u003e\n\u003cb\u003eUser Data\u003c/b\u003e auto-mapped parameters:\n\u003cul\u003e\n\u003cli\u003e\u003cb\u003eEmail\u003c/b\u003e: GA4 \u003ci\u003eemail\u003c/i\u003e, \u003ci\u003esha256_email_address\u003c/i\u003e, \u003ci\u003eemail_address\u003c/i\u003e, \u003ci\u003eemail\u003c/i\u003e or \u003ci\u003eem\u003c/i\u003e keys from  \u003ci\u003euser_data\u003c/i\u003e object in the Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003ePhone Number\u003c/b\u003e: GA4 \u003ci\u003ephone\u003c/i\u003e, \u003ci\u003esha256_phone_number\u003c/i\u003e, \u003ci\u003ephone_number\u003c/i\u003e or \u003ci\u003eph\u003c/i\u003e keys from  \u003ci\u003euser_data\u003c/i\u003e object in the Data Layer\u003c/li\u003e\n\u003cli\u003e\u003cb\u003eExternal ID\u003c/b\u003e:  GA4 \u003ci\u003euser_id\u003c/i\u003e, \u003ci\u003euserId\u003c/i\u003e, or \u003ci\u003eexternal_id\u003c/i\u003e keys from the Data Layer or from the \u003ci\u003euser_data\u003c/i\u003e object in the Data Layer\u003c/li\u003e\n\u003c/ul\u003e",
        "defaultValue": true,
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "enableMostRecentDataLayerEventOnly",
            "checkboxText": "Use data only from the most recent Data Layer event where the data can be found (ignore recursive merges)",
            "simpleValueType": true,
            "help": "If enabled, the tag will take data only from the most recent Data Layer event where the data can be found. \n\u003cbr/\u003e\u003cbr/\u003e\nIn other words, the tag will ignore recursive merges for Data Layer variables and take only the most recent value of the data. \u003ca href\u003d\"https://www.simoahava.com/gtm-tips/data-layer-variable-versions-explained/\"\u003eLearn more\u003c/a\u003e.",
            "defaultValue": false,
            "enablingConditions": [
              {
                "paramName": "enableDataLayerMapping",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ],
        "alwaysInSummary": true
      },
      {
        "type": "CHECKBOX",
        "name": "enableAdvancedMatching",
        "checkboxText": "Enable Advanced Matching",
        "simpleValueType": true,
        "help": "Advanced Matching helps you optimize your TikTok ads and drive performance by matching User Data with people on TikTok. Hashed User Data can be shared with any TikTok event to attribute more conversions, build bigger audiences and improve campaign optimization.\n\u003cbr/\u003e\u003cbr/\u003e\nNote: if a TikTok Pixel ID on the page is using User Data, then all the TikTok Pixel IDs implemented on the page will use this User Data too (even the ones that don\u0027t have the \"Enabled Advanced Matching\" option toggled on). The TikTok Pixel does not support a per-Pixel ID usage.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?rid\u003d5ipocbxyw8v\u0026id\u003d1739585700402178\"\u003eLearn more\u003c/a\u003e.",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "enableEventUserDataEnhancement",
            "checkboxText": "Enable Event User Data Enhancement",
            "simpleValueType": true,
            "help": "Enable the use of \u003ci\u003elocalStorage\u003c/i\u003e to store data for enhanced User Data tracking.\n\u003cbr/\u003e\u003cbr/\u003e\nNote: If the \u003ci\u003eEnable automatic data population from the Data Layer\u003c/i\u003e option is selected, all User Data found in the Data Layer will be stored, not just the fields explicitly defined in the User Data section.\n\u003cbr/\u003e\u003cbr/\u003e\nThis feature is a convenience and is not part of the default TikTok Pixel behavior. It is not integrated with the TikTok Pixel consent features (from the \u003ci\u003eCompliance Settings\u003c/i\u003e section below).",
            "subParams": [
              {
                "type": "CHECKBOX",
                "name": "storeUserDataHashed",
                "checkboxText": "Store User Data hashed",
                "simpleValueType": true,
                "help": "The User Data will be stored hashed in \u003ci\u003elocalStorage\u003c/i\u003e.",
                "enablingConditions": [
                  {
                    "paramName": "enableEventUserDataEnhancement",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "enableAdvancedMatching",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ],
        "defaultValue": true,
        "alwaysInSummary": true
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "complianceSettingsGroup",
    "displayName": "Compliance Settings",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "GROUP",
        "name": "tikTokConsentGroup",
        "subParams": [
          {
            "type": "SELECT",
            "name": "consentOptMode",
            "displayName": "Default TikTok Consent Mode",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "optout",
                "displayValue": "User Opt-out"
              },
              {
                "value": "optin",
                "displayValue": "User Opt-in"
              }
            ],
            "simpleValueType": true,
            "help": "\u003cb\u003eUser Opt-in\u003c/b\u003e: this solution will prevent pixels from sharing data with TikTok until user consent is explicitly granted. After consent is granted on the page, events that were previously queued in the page before consent was granted will be sent.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eUser Opt-out\u003c/b\u003e: this solution will allow pixels to share data with TikTok until user consent is explicitly revoked. Events already sent to TikTok won\u0027t be affected.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1795929012554754\"\u003eLearn more\u003c/a\u003e (note that the opt-in and opt-out definition is switched).",
            "notSetText": "(not set)"
          },
          {
            "type": "SELECT",
            "name": "consent",
            "displayName": "Consent",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "granted",
                "displayValue": "granted"
              },
              {
                "value": "denied",
                "displayValue": "denied"
              }
            ],
            "simpleValueType": true,
            "help": "\u003cb\u003eConsent Granted\u003c/b\u003e accepted values: \u003ci\u003etrue\u003c/i\u003e, \u003ci\u003e\"true\"\u003c/i\u003e, \u003ci\u003e1\u003c/i\u003e, \u003ci\u003e\"1\"\u003c/i\u003e, or \u003ci\u003e\"granted\"\u003c/i\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eConsent Denied\u003c/b\u003e accepted values: \u003ci\u003efalse\u003c/i\u003e, \u003ci\u003e\"false\"\u003c/i\u003e, \u003ci\u003e0\u003c/i\u003e, \u003ci\u003e\"0\"\u003c/i\u003e, or \u003ci\u003e\"denied\"\u003c/i\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nAny other value will be considered as \u003cb\u003eConsent Unknown\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nWhen \u003cb\u003eConsent Denied\u003c/b\u003e events won\u0027t be sent. The tracking resumes only when an event fires with \u003cb\u003eConsent Granted\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1795929012554754\"\u003eLearn more\u003c/a\u003e.",
            "notSetText": "(not set)"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "enableGoogleConsentMode",
            "paramValue": false,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "enableGoogleConsentMode",
        "checkboxText": "Enable Google Consent Mode support",
        "simpleValueType": true,
        "help": "When enabled, this tag checks for the Google Consent Mode \u003ci\u003ead_storage\u003c/i\u003e consent.\n\u003cbr/\u003e\nIf consent is not granted, the TikTok pixel consent is set as revoked. \n\u003cbr/\u003e\nIf consent is granted (initially or later), the pixel consent is automatically granted.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1795929012554754\"\u003eLearn more\u003c/a\u003e (note that the opt-in and opt-out definition is switched)."
      },
      {
        "type": "CHECKBOX",
        "name": "enableLDU",
        "checkboxText": "Enable Limited Data Use (LDU)",
        "simpleValueType": true,
        "help": "Limited Data Use is a feature to give businesses more control over how their event data is used in TikTok\u0027s systems under certain U.S. state privacy laws. \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1770092377990145\"\u003eLearn more\u003c/a\u003e.",
        "subParams": [
          {
            "type": "SELECT",
            "name": "modeLDU",
            "displayName": "LDU Mode",
            "macrosInSelect": false,
            "selectItems": [
              {
                "value": "all",
                "displayValue": "All Events"
              },
              {
                "value": "single",
                "displayValue": "Single Event"
              }
            ],
            "simpleValueType": true,
            "help": "Choose whether the Limited Data Use (LDU) will be applied to all events, or to the specific event triggered by this tag.",
            "defaultValue": "all",
            "enablingConditions": [
              {
                "paramName": "enableLDU",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "displayName": "User Data",
    "name": "userDataGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "userDataLabel",
        "displayName": "Check this \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?rid\u003d5ipocbxyw8v\u0026id\u003d1739585700402178\"\u003edocumentation\u003c/a\u003e for more details on accepted User Data parameters.\n\u003cbr/\u003e\nThe tag will automatically hash parameters that need it, pre-hashed data is also accepted.\n\u003cbr/\u003e\u003cbr/\u003e"
      },
      {
        "type": "SELECT",
        "name": "userDataFromVariable",
        "displayName": "Load Parameters From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can use a standard User-Provided Data variable or create a variable that returns a JavaScript object containing the desired User Data parameters. This object will merge with additional parameters from the table below, with any conflicts resolved in favor of the table entries."
      },
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "email",
                "displayValue": "Email Address"
              },
              {
                "value": "phone_number",
                "displayValue": "Phone Number"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              }
            ],
            "defaultValue": ""
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT",
            "valueValidators": []
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add parameter"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "enableAdvancedMatching",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "Event Parameters",
    "name": "eventParametersGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "eventParametersLabel",
        "displayName": "Check this \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?rid\u003d5ipocbxyw8v\u0026id\u003d1739585702922241#item-link-Parameters\"\u003edocumentation\u003c/a\u003e for more details on accepted Event Parameters.\n\u003cbr/\u003e\u003cbr/\u003e"
      },
      {
        "type": "SELECT",
        "name": "eventParametersFromVariable",
        "displayName": "Load Parameters From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can create a variable that returns a JavaScript object with the desired Event Parameters. This object will merge with additional parameters from the table below, with any conflicts resolved in favor of the table entries."
      },
      {
        "name": "eventParametersList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "content_type",
                "displayValue": "content_type"
              },
              {
                "value": "content_ids",
                "displayValue": "content_ids"
              },
              {
                "value": "contents",
                "displayValue": "contents"
              },
              {
                "value": "currency",
                "displayValue": "currency"
              },
              {
                "value": "value",
                "displayValue": "value"
              },
              {
                "value": "num_items",
                "displayValue": "num_items"
              },
              {
                "value": "search_string",
                "displayValue": "search_string"
              },
              {
                "value": "description",
                "displayValue": "description"
              },
              {
                "value": "status",
                "displayValue": "status"
              },
              {
                "value": "delivery_category",
                "displayValue": "delivery_category"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add parameter"
      }
    ]
  },
  {
    "displayName": "Additional Event Parameters",
    "name": "additionalEventParametersGroup",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "additionalEventParametersLabel",
        "displayName": "Use Additional Event Parameters to send any custom parameter or parameters specific to a vertical (Travel, Automotive etc.).\n\u003cbr/\u003e\nCheck these documentations for more details on Additional Event Parameters for \u003ca href\u003d\"https://ads.tiktok.com/help/article/available-events-and-parameters-for-travel-ads?lang\u003den\n\"\u003eTravel Ads\u003c/a\u003e and \u003ca href\u003d\"https://ads.tiktok.com/help/article/available-parameters-for-automotive-ads?lang\u003den\"\u003eAutomotive Ads\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e"
      },
      {
        "type": "SELECT",
        "name": "additionalEventParametersFromVariable",
        "displayName": "Load Parameters From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can create a variable that returns a JavaScript object with the desired Additional Event Parameters. This object will merge with additional parameters from the table below, with any conflicts resolved in favor of the table entries."
      },
      {
        "name": "additionalEventParametersList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "",
            "displayName": "Parameter Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Parameter Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add parameter"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "serverSideSettingsGroup",
    "displayName": "Server Side Tracking Settings",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventId",
        "displayName": "Event ID",
        "simpleValueType": true,
        "help": "Set the Event ID parameter in case you are tracking the same event via server-side using the Conversion API (Events API).\n\u003cbr/\u003e\nThe Event ID can be used to deduplicate the same event if sent from multiple sources. Learn more: \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1799004097478658#item-link-How%20to%20set%20up%20deduplication\"\u003e[1]\u003c/a\u003e,\n\u003ca href\u003d\"https://ads.tiktok.com/help/article/event-deduplication?lang\u003den\"\u003e[2]\u003c/a\u003e and \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1739584864945154\"\u003e[3]\u003c/a\u003e"
      },
      {
        "type": "GROUP",
        "name": "advancedSettingsGroup",
        "displayName": "Advanced Settings",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "CHECKBOX",
            "name": "pushEventIdToDataLayer",
            "checkboxText": "Push event to DataLayer with the Event ID",
            "simpleValueType": true,
            "help": "It\u0027s helpful for easier events deduplication with the server.-side event. You can use this event to trigger the tag that send data to the server container and forward the correct Event ID.",
            "defaultValue": false
          },
          {
            "type": "GROUP",
            "name": "eventIdDataLayerConfigGroup",
            "subParams": [
              {
                "type": "TEXT",
                "name": "eventIdDataLayerEventName",
                "displayName": "DataLayer Event Name",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "valueHint": "page_view_unique",
                "help": "Be careful not to use an Event Name that can trigger this tag, otherwise the tag will enter in an infinite loop."
              },
              {
                "type": "TEXT",
                "name": "eventIdDataLayerVariableName",
                "displayName": "DataLayer Array Name",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "defaultValue": "dataLayer",
                "help": "Use dataLayer by default. Modify only if you renamed dataLayer object name."
              }
            ],
            "enablingConditions": [
              {
                "paramName": "pushEventIdToDataLayer",
                "paramValue": true,
                "type": "EQUALS"
              }
            ]
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "additionalSettingsGroup",
    "displayName": "Additional Settings",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "disableHistoryObserver",
        "checkboxText": "Disable History Event Tracking",
        "simpleValueType": true,
        "help": "The TikTok Pixel \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1801524003169281\"\u003eautomatically tracks history events\u003c/a\u003e (pushState and replaceState) as a \u003ci\u003ePageview\u003c/i\u003e. These automatically collected events don\u0027t carry the parameters defined by the user (such as Event ID etc.).\n\u003cbr/\u003e\u003cbr/\u003e\nCheck this box to \u003cb\u003edisable\u003c/b\u003e this automatic tracking. Make sure to implement it manually instead.\n\u003cbr/\u003e\u003cbr/\u003e\nDisabling it can be useful to deduplicate (\u003ca href\u003d\"https://ads.tiktok.com/help/article/event-deduplication?lang\u003den\"\u003e[1]\u003c/a\u003e and \u003ca href\u003d\"https://business-api.tiktok.com/portal/docs?id\u003d1739584864945154\"\u003e[2]\u003c/a\u003e) the \u003ci\u003ePageview\u003c/i\u003e event when using the Conversions API (Events API). This way you can make sure to send the correct Event ID in both web and server events."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const addConsentListener = require('addConsentListener');
const callInWindow = require('callInWindow');
const copyFromDataLayer = require('copyFromDataLayer');
const copyFromWindow = require('copyFromWindow');
const createQueue = require('createQueue');
const encodeUriComponent = require('encodeUriComponent');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const injectScript = require('injectScript');
const isConsentGranted = require('isConsentGranted');
const JSON = require('JSON');
const localStorage = require('localStorage');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const makeTableMap = require('makeTableMap');
const Object = require('Object');
const setInWindow = require('setInWindow');
const sha256 = require('sha256');
const templateStorage = require('templateStorage');

/*==============================================================================
==============================================================================*/

const queueName = 'ttq';
getOrCreateTikTokQueue(queueName);
setConsent(data, queueName);
sendEvent(data, queueName);

/*==============================================================================
  Vendor related functions
==============================================================================*/

function getOrCreateTikTokQueue(queueName) {
  const existingQueue = copyFromWindow(queueName);
  if (existingQueue) return existingQueue;

  setInWindow('TiktokAnalyticsObject', queueName);
  const newQueue = [];

  // prettier-ignore
  newQueue.methods = ['page','track','identify','instances','debug','on','off','once','ready','alias','group','enableCookie','disableCookie','holdConsent','revokeConsent','grantConsent'];

  // "pixelId" parameter is not present in the original method.
  // We need it to determine which queue to be used during the execution of the inner function.
  newQueue.setAndDefer = (queue, command, pixelId) => {
    queue[command] = () => {
      const currentQueue = copyFromWindow(queueName);
      const currentPixelQueue = pixelId
        ? (currentQueue._i[pixelId] = currentQueue._i[pixelId] || [])
        : undefined;
      (pixelId ? currentPixelQueue : currentQueue).push(
        [command].concat(convertArgumentstoArray(arguments))
      );
      if (pixelId) setInWindow(queueName + '._i', currentQueue._i, true);
      else setInWindow(queueName, currentQueue, true);
    };
  };

  newQueue.methods.forEach((method) => newQueue.setAndDefer(newQueue, method));

  newQueue.instance = (pixelId) => {
    const _i = copyFromWindow(queueName + '._i');
    const currentPixelQueue = (_i[pixelId] = _i[pixelId] || []);
    newQueue.methods.forEach((method) => newQueue.setAndDefer(currentPixelQueue, method, pixelId));
    setInWindow(queueName + '._i', _i, true);
    return currentPixelQueue;
  };

  newQueue.load = (pixelId, options, asyncScriptLoadManagerStorageConfig) => {
    const scriptBaseUrl = 'https://analytics.tiktok.com/i18n/pixel/events.js';
    const scriptUrl = scriptBaseUrl + '?sdkid=' + encodeUriComponent(pixelId) + '&lib=' + queueName;

    const _i = copyFromWindow(queueName + '._i') || {};
    _i[pixelId] = [];
    _i[pixelId]._u = scriptBaseUrl;
    setInWindow(queueName + '._i', _i, true);

    const _t = copyFromWindow(queueName + '._t') || {};
    _t[pixelId] = getTimestampMillis();
    setInWindow(queueName + '._t', _t, true);

    const _o = copyFromWindow(queueName + '._o') || {};
    _o[pixelId] = options || {};
    setInWindow(queueName + '._o', _o, true);

    let asyncScriptLoadManager;
    if (
      getType(asyncScriptLoadManagerStorageConfig) === 'object' &&
      asyncScriptLoadManagerStorageConfig.asyncScriptLoadManagerStorageKey
    ) {
      const asyncScriptLoadManagerStorageKey =
        asyncScriptLoadManagerStorageConfig.asyncScriptLoadManagerStorageKey;
      asyncScriptLoadManager = templateStorage.getItem(asyncScriptLoadManagerStorageKey);
      if (getType(asyncScriptLoadManager) === 'object') {
        asyncScriptLoadManager.pendingInjectScriptCalls += 1;
        templateStorage.setItem(asyncScriptLoadManagerStorageKey, asyncScriptLoadManager);
      }
    }

    injectScript(
      scriptUrl,
      () => {
        if (getType(asyncScriptLoadManager) === 'object') {
          asyncScriptLoadManager.maybeCallTagExecutionHandler();
        }
      },
      () => {
        if (getType(asyncScriptLoadManager) === 'object') {
          asyncScriptLoadManager.someFailed = true;
          asyncScriptLoadManager.maybeCallTagExecutionHandler();
        }
      },
      'ttqPixel-' + pixelId
    );
  };

  setInWindow(queueName, newQueue, true);
}

function setConsent(data, queueName) {
  if (data.enableGoogleConsentMode) {
    if (!isConsentGranted('ad_storage')) {
      callInWindow(queueName + '.revokeConsent');

      let wasCalled = false;
      addConsentListener('ad_storage', (consentType, granted) => {
        if (wasCalled || consentType !== 'ad_storage' || !granted) return;
        wasCalled = true;
        callInWindow(queueName + '.grantConsent');
      });
    } else {
      callInWindow(queueName + '.grantConsent');
    }

    return;
  }

  if (data.consentOptMode === 'optin') callInWindow(queueName + '.holdConsent');
  if (isUIConsentFieldGranted(data.consent)) callInWindow(queueName + '.grantConsent');
  else if (isUIConsentFieldDenied(data.consent)) callInWindow(queueName + '.revokeConsent');
}

function getLoadOptions(data) {
  const loadOptions = {};
  if (data.disableHistoryObserver) loadOptions.historyObserver = false;
  if (data.enableLDU && data.modeLDU === 'all') loadOptions.limited_data_use = true;
  return loadOptions;
}

function getEventName(data) {
  if (data.eventNameSetupMethod === 'inherit') {
    const eventName = copyFromDataLayer('event');

    const ga4ToTikTokEventName = {
      page_view: 'Pageview',
      'gtm.dom': 'Pageview',
      add_payment_info: 'AddPaymentInfo',
      add_to_cart: 'AddToCart',
      add_to_wishlist: 'AddToWishlist',
      sign_up: 'CompleteRegistration',
      begin_checkout: 'InitiateCheckout',
      generate_lead: 'Lead',
      purchase: 'Purchase',
      search: 'Search',
      view_item: 'ViewContent',

      contact: 'Contact',
      customize_product: 'CustomizeProduct',
      donate: 'Donate',
      find_location: 'FindLocation',
      schedule: 'Schedule',
      start_trial: 'StartTrial',
      submit_application: 'SubmitApplication',
      subscribe: 'Subscribe',

      page_view_stape: 'Pageview',
      add_payment_info_stape: 'AddPaymentInfo',
      add_to_cart_stape: 'AddToCart',
      sign_up_stape: 'CompleteRegistration',
      begin_checkout_stape: 'InitiateCheckout',
      purchase_stape: 'Purchase',
      view_item_stape: 'ViewContent',

      'gtm4wp.addProductToCartEEC': 'AddToCart',
      'gtm4wp.productClickEEC': 'ViewContent',
      'gtm4wp.checkoutOptionEEC': 'InitiateCheckout',
      'gtm4wp.checkoutStepEEC': 'AddPaymentInfo',
      'gtm4wp.orderCompletedEEC': 'Purchase'
    };

    return ga4ToTikTokEventName[eventName] || eventName;
  }

  return data.eventName === 'standard' ? data.eventNameStandard : data.eventNameCustom;
}

function pushEventIdToDataLayer(data) {
  if (!data.pushEventIdToDataLayer) return;

  const dataLayerQueueName = data.eventIdDataLayerVariableName || 'dataLayer';
  const dataLayerPush = createQueue(dataLayerQueueName);
  dataLayerPush({
    eventId: data.eventId,
    event: data.eventIdDataLayerEventName || 'tiktokPixelDataLayerPush'
  });
}

function getEventUserDataEnhancement() {
  if (localStorage) {
    const gtmeec = localStorage.getItem('gtmeec-tt');
    if (gtmeec) {
      const gtmeecParsed = JSON.parse(gtmeec);
      if (getType(gtmeecParsed) === 'object') return gtmeecParsed;
    }
  }

  return {};
}

function normalizeBasedOnSchemaKey(schemaKey, identifier) {
  switch (schemaKey) {
    case 'phone_number':
      return normalizePhoneNumber(identifier);
    case 'email':
      return normalizeEmail(identifier);
    case 'external_id':
      return removeWhiteSpace(identifier);
    default:
      return identifier;
  }
}

function hashUserDataFields(userData, storeUserDataInLocalStorage) {
  const canUseHashSync = getType(copyFromWindow('dataTag256')) === 'function';
  const hashAsyncHelpers = {
    pendingHashs: 0,
    maybeFinish: (userDataHashed) => {
      if (hashAsyncHelpers.pendingHashs === 0) storeUserDataInLocalStorage(userDataHashed);
    }
  };

  const userDataHashed = {};

  const fieldNames = Object.keys(userData);
  fieldNames.forEach((fieldName) => {
    const value = userData[fieldName];

    if (value === undefined || value === null || value === '') return;
    if (isHashed(value)) {
      userDataHashed[fieldName] = value;
      return;
    }

    const normalizedValue = makeString(normalizeBasedOnSchemaKey(fieldName, value)).trim();
    if (canUseHashSync) {
      userDataHashed[fieldName] = callInWindow('dataTag256', normalizedValue, 'HEX');
    } else {
      hashAsyncHelpers.pendingHashs++;
      sha256(
        normalizedValue,
        (digest) => {
          userDataHashed[fieldName] = digest;
          hashAsyncHelpers.pendingHashs--;
          hashAsyncHelpers.maybeFinish(userDataHashed);
        },
        () => {
          hashAsyncHelpers.pendingHashs--;
        },
        { outputEncoding: 'hex' }
      );
    }
  });

  if (canUseHashSync) {
    storeUserDataInLocalStorage(userDataHashed);
    return userDataHashed;
  } else {
    hashAsyncHelpers.maybeFinish(userDataHashed);
    return;
  }
}

function storeUserDataInLocalStorage(userData) {
  if (!objHasProps(userData)) return;
  const gtmeec = JSON.stringify(userData);
  localStorage.setItem('gtmeec-tt', gtmeec);
}

function storeEventUserDataEnhancement(data, userData) {
  if (localStorage && objHasProps(userData)) {
    if (!data.storeUserDataHashed) storeUserDataInLocalStorage(userData);
    else hashUserDataFields(userData, storeUserDataInLocalStorage);
  }
}

function addUserData(userData, userDataFrom, useDL) {
  let email =
    userDataFrom.email ||
    userDataFrom.sha256_email_address ||
    userDataFrom.email_address ||
    userDataFrom.email ||
    userDataFrom.em;
  const emailType = getType(email);
  if (emailType === 'array' || emailType === 'object') email = email[0];
  if (email) userData.email = email;

  let phone =
    userDataFrom.phone ||
    userDataFrom.sha256_phone_number ||
    userDataFrom.phone_number ||
    userDataFrom.ph;
  const phoneType = getType(phone);
  if (phoneType === 'array' || phoneType === 'object') phone = phone[0];
  if (phone) userData.phone_number = phone;

  if (userDataFrom.external_id) userData.external_id = userDataFrom.external_id;
  else if (userDataFrom.user_id) userData.external_id = userDataFrom.user_id;
  else if (userDataFrom.userId) userData.external_id = userDataFrom.userId;
  else if (useDL && copyFromDataLayerWithVersion('external_id'))
    userData.external_id = copyFromDataLayerWithVersion('external_id');
  else if (useDL && copyFromDataLayerWithVersion('user_id'))
    userData.external_id = copyFromDataLayerWithVersion('user_id');
  else if (useDL && copyFromDataLayerWithVersion('userId'))
    userData.external_id = copyFromDataLayerWithVersion('userId');

  return userData;
}

function getUserData(data) {
  if (!data.enableAdvancedMatching) return;

  let userData = {};

  if (data.enableEventUserDataEnhancement) {
    userData = getEventUserDataEnhancement();
  }

  if (data.enableDataLayerMapping) {
    const userDataFromDataLayer = copyFromDataLayerWithVersion('user_data');
    if (getType(userDataFromDataLayer) === 'object') {
      addUserData(userData, userDataFromDataLayer, true);
    }
  }

  if (getType(data.userDataFromVariable) === 'object') {
    addUserData(userData, data.userDataFromVariable, false);
  }

  if (data.userDataList && data.userDataList.length) {
    mergeObj(userData, makeTableMap(data.userDataList, 'name', 'value'));
  }

  if (objIsEmptyOrContainsOnlyFalsyValues(userData)) return;

  if (data.enableEventUserDataEnhancement) {
    storeEventUserDataEnhancement(data, userData);
  }

  return userData;
}

function addUAEventParameters(eventName, eventParameters, ecommerce) {
  const eventActionMap = {
    ViewContent: 'detail',
    AddToCart: 'add',
    InitiateCheckout: 'checkout',
    Purchase: 'purchase'
  };

  if (eventActionMap[eventName]) {
    const action = eventActionMap[eventName];
    let valueFromItems = 0;

    if (
      getType(ecommerce[action]) === 'object' &&
      getType(ecommerce[action].products) === 'array' &&
      ecommerce[action].products.length
    ) {
      eventParameters.contents = [];
      eventParameters.content_ids = [];
      eventParameters.content_type = 'product';
      eventParameters.num_items = 0;

      ecommerce[action].products.forEach((d) => {
        const content = {};
        if (d.id) content.content_id = makeString(d.id);
        content.quantity = makeNumber(d.quantity) || 1;
        if (d.price) {
          const price = makeNumber(d.price);
          valueFromItems += content.quantity ? content.quantity * price : price;
          content.price = price;
        }
        if (d.category) content.content_category = makeString(d.category);
        if (d.name) content.content_name = makeString(d.name);
        if (d.brand) content.brand = makeString(d.brand);

        eventParameters.contents.push(content);
        eventParameters.num_items += content.quantity || 1;
        eventParameters.content_ids.push(content.content_id);
      });
    }

    const value =
      (getType(ecommerce[action].actionField) === 'object' && ecommerce[action].actionField.revenue
        ? ecommerce[action].actionField.revenue
        : undefined) || valueFromItems;
    if (value) eventParameters.value = makeNumber(value);

    const currency = ecommerce.currencyCode;
    if (currency) eventParameters.currency = ecommerce.currencyCode;
  }

  return eventParameters;
}

function addGA4EventParameters(eventParameters, items) {
  let currencyFromItems = '';
  let valueFromItems = 0;

  if (getType(items) === 'array' && items.length) {
    eventParameters.contents = [];
    eventParameters.content_ids = [];
    eventParameters.content_type = 'product';
    eventParameters.num_items = 0;
    currencyFromItems = items[0].currency;

    items.forEach((d) => {
      const content = {};
      if (d.item_id) content.content_id = makeString(d.item_id);
      content.quantity = makeNumber(d.quantity) || 1;

      if (d.price) {
        const price = makeNumber(d.price);
        valueFromItems += content.quantity ? content.quantity * price : price;
        content.price = price;
      }

      const contentCategories = [];
      if (d.item_category) contentCategories.push(makeString(d.item_category));
      if (d.item_category2) contentCategories.push(makeString(d.item_category2));
      if (d.item_category3) contentCategories.push(makeString(d.item_category3));
      if (d.item_category4) contentCategories.push(makeString(d.item_category4));
      if (d.item_category5) contentCategories.push(makeString(d.item_category5));
      if (contentCategories.length) content.content_category = contentCategories.join(',');

      if (d.item_name) content.content_name = makeString(d.item_name);
      if (d.item_brand) content.brand = makeString(d.item_brand);

      eventParameters.contents.push(content);
      eventParameters.num_items += content.quantity || 1;
      eventParameters.content_ids.push(content.content_id);
    });
  }

  const value = copyFromDataLayerWithVersion('value') || valueFromItems;
  if (value) eventParameters.value = makeNumber(value);

  const currency = copyFromDataLayerWithVersion('currency') || currencyFromItems;
  if (currency) eventParameters.currency = currency;

  const searchTerm = copyFromDataLayerWithVersion('search_term');
  if (searchTerm) eventParameters.search_string = makeString(searchTerm);

  return eventParameters;
}

function getEventParameters(data, eventName) {
  const eventParameters = {
    gtm_version: 'stape_gtm_1_0_0',
    event_trigger_source: 'GoogleTagManagerClient'
  };

  if (data.enableLDU && data.modeLDU === 'single') eventParameters.limited_data_use = true;

  if (data.enableDataLayerMapping) {
    const ecommerceObjFromDataLayer = copyFromDataLayerWithVersion('ecommerce');
    let itemsObjFromDataLayer = copyFromDataLayerWithVersion('items');
    if (
      getType(itemsObjFromDataLayer) !== 'array' &&
      getType(ecommerceObjFromDataLayer) === 'object' &&
      getType(ecommerceObjFromDataLayer.items) === 'array'
    ) {
      itemsObjFromDataLayer = ecommerceObjFromDataLayer.items;
    }

    if (itemsObjFromDataLayer) {
      addGA4EventParameters(eventParameters, itemsObjFromDataLayer);
    }

    if (!eventParameters.content_type && ecommerceObjFromDataLayer) {
      addUAEventParameters(eventName, eventParameters, ecommerceObjFromDataLayer);
    }
  }

  if (getType(data.eventParametersFromVariable) === 'object') {
    mergeObj(eventParameters, data.eventParametersFromVariable);
  }

  if (data.eventParametersList && data.eventParametersList.length) {
    mergeObj(eventParameters, makeTableMap(data.eventParametersList, 'name', 'value'));
  }

  if (getType(data.eventCustomParametersFromVariable) === 'object') {
    mergeObj(eventParameters, data.eventCustomParametersFromVariable);
  }

  if (data.eventCustomParametersList && data.eventCustomParametersList.length) {
    mergeObj(eventParameters, makeTableMap(data.eventCustomParametersList, 'name', 'value'));
  }

  return eventParameters;
}

function sendEvent(data, queueName) {
  const pixelIds = getType(data.pixelIds) === 'string' ? data.pixelIds.split(',') : data.pixelIds;
  if (getType(pixelIds) !== 'array' || pixelIds.length === 0) return data.gtmOnFailure();

  const initializedPixelIds = copyFromWindow('_tiktok_gtm_ids') || {};
  let loadWasNotCalled = true;
  const loadOptions = getLoadOptions(data);
  const userData = getUserData(data);
  let identifyWasNotCalled = true;
  const eventName = getEventName(data);
  const eventParameters = getEventParameters(data, eventName);

  const asyncScriptLoadManagerStorageKey = setAsyncScriptLoadManager(data);

  pixelIds.forEach((pixelId) => {
    const pixelIdIsNotInitialized = !initializedPixelIds[pixelId];
    if (pixelIdIsNotInitialized) {
      initializedPixelIds[pixelId] = true;
      loadWasNotCalled = false;
      setInWindow('_tiktok_gtm_ids', initializedPixelIds, true);
      callInWindow(queueName + '.load', pixelId, loadOptions, {
        asyncScriptLoadManagerStorageKey: asyncScriptLoadManagerStorageKey
      });
    }

    if (identifyWasNotCalled && objHasProps(userData)) {
      identifyWasNotCalled = false;
      callInWindow(queueName + '.identify', userData);
    }

    callInWindow(queueName + '.track', eventName, eventParameters, {
      event_id: data.eventId,
      pixel_code: pixelId // Ensures the event is sent to this "pixelId" only.
    });
  });

  pushEventIdToDataLayer(data);

  if (loadWasNotCalled) {
    templateStorage.removeItem(asyncScriptLoadManagerStorageKey);
    return data.gtmOnSuccess();
  }
}

/*==============================================================================
  Helpers
==============================================================================*/

/**
 * The asyncScriptLoadManagerStorageKey helper object is used to handle multiple asynchronous script injections.
 * It ensures that the tag execution status is reported only after all scripts have finished loading.
 */
function setAsyncScriptLoadManager(data) {
  const tagExecutionId = data.gtmTagId + '-' + data.gtmEventId + '-' + getTimestampMillis();
  const asyncScriptLoadManagerStorageKey = 'asyncScriptLoadManager-' + tagExecutionId;
  const asyncScriptLoadManager = {
    pendingInjectScriptCalls: 0,
    someFailed: false,
    maybeCallTagExecutionHandler: () => {
      const manager = templateStorage.getItem(asyncScriptLoadManagerStorageKey);
      manager.pendingInjectScriptCalls--;
      if (manager.pendingInjectScriptCalls === 0) {
        templateStorage.removeItem(asyncScriptLoadManagerStorageKey);
        return manager.someFailed ? data.gtmOnFailure() : data.gtmOnSuccess();
      }
      templateStorage.setItem(asyncScriptLoadManagerStorageKey, manager);
    }
  };
  templateStorage.setItem(asyncScriptLoadManagerStorageKey, asyncScriptLoadManager);
  return asyncScriptLoadManagerStorageKey;
}

function convertArgumentstoArray(args) {
  const argumentsAsArray = [];
  for (let i = 0; i < args.length; i++) argumentsAsArray.push(args[i]);
  return argumentsAsArray;
}

function isUIConsentFieldGranted(field) {
  return [true, 'true', 1, '1', 'granted'].indexOf(field) !== -1;
}

function isUIConsentFieldDenied(field) {
  return [false, 'false', 0, '0', 'denied'].indexOf(field) !== -1;
}

function objHasProps(obj) {
  return getType(obj) === 'object' && Object.keys(obj).length > 0;
}

function objIsEmptyOrContainsOnlyFalsyValues(obj) {
  if (getType(obj) !== 'object') return;
  const objValues = Object.values(obj);
  if (objValues.length === 0 || objValues.every((v) => !v)) return true;
}

function mergeObj(target, source) {
  for (const key in source) {
    if (source.hasOwnProperty(key)) target[key] = source[key];
  }
  return target;
}

function isHashed(value) {
  if (!value) return false;
  return makeString(value).match('^[A-Fa-f0-9]{64}$') !== null;
}

function normalizePhoneNumber(phoneNumber) {
  if (!phoneNumber) return;
  phoneNumber = makeString(phoneNumber)
    .split('+')
    .join('')
    .split(' ')
    .join('')
    .split('-')
    .join('')
    .split('(')
    .join('')
    .split(')')
    .join('');
  if (phoneNumber[0] !== '+') phoneNumber = '+' + phoneNumber;
  return phoneNumber;
}

function normalizeEmail(email) {
  if (!email) return;
  return removeWhiteSpace(makeString(email)).toLowerCase();
}

function removeWhiteSpace(input) {
  if (!input) return;
  return makeString(input).split(' ').join('');
}

function copyFromDataLayerWithVersion(key) {
  const dataLayerVersion = data.enableMostRecentDataLayerEventOnly ? 1 : 2;
  return copyFromDataLayer(key, dataLayerVersion);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_tiktok_gtm_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "TiktokAnalyticsObject"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq.track"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq.identify"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq.load"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq.holdConsent"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq.revokeConsent"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq.grantConsent"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq._i"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq._t"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ttq._o"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataTag256"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://analytics.tiktok.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtmeec-tt"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_template_storage",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 11/25/2025, 10:44:33 AM

